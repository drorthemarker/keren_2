<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Text Synchronizer - Manual File Load</title>
    <style>
        :root { --highlight-color: #FFD700; --primary-blue: #007bff; --mic-active-color: #dc3545; --light-gray: #6c757d; --orange-color: #fd7e14; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; display: flex; flex-direction: column; align-items: center; background-color: #f4f4f9; margin: 0; padding: 20px; box-sizing: border-box; }
        .container { width: 90%; max-width: 900px; background: white; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); padding: 20px; margin-top: 15px; }
        #file-selection { width: 90%; max-width: 900px; margin-bottom: 20px; text-align: right; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .file-upload-area { display: flex; justify-content: space-around; gap: 15px; margin-bottom: 20px; }
        #text-display { height: 20vh; overflow-y: auto; border: 1px solid #ddd; padding: 15px; font-size: 24px; line-height: 2.3; margin-bottom: 20px; display: flex; align-items: center; justify-content: center; }
        #text-display span.highlight-chunk { background-color: var(--highlight-color); color: black; border-radius: 4px; }
        .controls { display: flex; justify-content: center; flex-wrap: wrap; gap: 10px; align-items: center; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; border: none; border-radius: 5px; background-color: var(--primary-blue); color: white; transition: background-color 0.2s; min-width: 180px; text-align: center;}
        button.upload-btn { background-color: var(--light-gray); flex-grow: 1; }
        button#play-mic-btn.active { background-color: var(--mic-active-color); }
        button#restart-btn { background-color: var(--orange-color); }
        button:hover:not(:disabled) { opacity: 0.85; }
        button:disabled { background-color: #a0a0a0; cursor: not-allowed; }
        .font-controls { display: flex; gap: 5px; }
        .font-controls button { min-width: 45px; font-size: 20px; font-weight: bold; }
        #status { font-size: 16px; color: #333; height: 20px; margin-top: 15px; text-align: center;}
    </style>
</head>
<body>
    <h1>מסנכרן אודיו וטקסט</h1>

    <div id="file-selection">
        <h2>אנא העלה את הקבצים שלך:</h2>
        <div class="file-upload-area">
            <input type="file" id="audio-file-input" accept=".wav,audio/wav" style="display: none;">
            <input type="file" id="timestamp-file-input" accept=".txt,text/plain" style="display: none;">
            <button id="upload-audio-btn" class="upload-btn">בחר קובץ שמע (wav)</button>
            <button id="upload-sync-btn" class="upload-btn">בחר קובץ תזמונים (txt)</button>
        </div>
        <button id="load-files-btn" disabled>טען קבצים</button>
    </div>

    <p id="status">בחר קובץ שמע וקובץ תזמונים כדי להפעיל את כפתור הטעינה.</p>

    <div class="container" style="display: none;">
        <div id="text-display"></div>
        <div class="controls">
            <button id="play-chunk-btn" disabled>נגן מקטע הבא</button>
            <button id="play-mic-btn" disabled>התחל עם מיקרופון</button>
            <button id="restart-btn" disabled>התחל מחדש</button>
            <div class="font-controls">
                <button id="font-decrease-btn" title="הקטן גופן">-</button>
                <button id="font-increase-btn" title="הגדל גופן">+</button>
            </div>
        </div>
    </div>

    <script>
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const isSpeechRecognitionSupported = SpeechRecognition != null;

        const elements = {
            textDisplay: document.getElementById('text-display'),
            playChunkBtn: document.getElementById('play-chunk-btn'),
            playMicBtn: document.getElementById('play-mic-btn'),
            restartBtn: document.getElementById('restart-btn'),
            fontIncreaseBtn: document.getElementById('font-increase-btn'),
            fontDecreaseBtn: document.getElementById('font-decrease-btn'),
            status: document.getElementById('status'),
            container: document.querySelector('.container'),
            loadFilesBtn: document.getElementById('load-files-btn'),
            audioFileInput: document.getElementById('audio-file-input'),
            timestampFileInput: document.getElementById('timestamp-file-input'),
            uploadAudioBtn: document.getElementById('upload-audio-btn'),
            uploadSyncBtn: document.getElementById('upload-sync-btn'),
        };

        let audioContext, audioBuffer, currentChunkSource;
        let recognition, isMicrophoneMode = false;
        let currentFontSize = 24;

        let state = {
            timestamps: [],
            chunkIndex: 0,
        };
        
        window.addEventListener('DOMContentLoaded', () => {
            if (!isSpeechRecognitionSupported) {
                elements.playMicBtn.disabled = true;
                elements.playMicBtn.textContent = 'מיקרופון לא נתמך';
            }
        });

        function checkFilesSelected() {
            const audioFile = elements.audioFileInput.files[0];
            const timestampFile = elements.timestampFileInput.files[0];
            elements.loadFilesBtn.disabled = !(audioFile && timestampFile);
            if (audioFile && timestampFile) {
                 elements.status.textContent = 'קבצים נבחרו. לחץ על "טען קבצים" כדי להמשיך.';
            }
        }

        elements.uploadAudioBtn.addEventListener('click', () => elements.audioFileInput.click());
        elements.uploadSyncBtn.addEventListener('click', () => elements.timestampFileInput.click());

        elements.audioFileInput.addEventListener('change', () => {
            const file = elements.audioFileInput.files[0];
            if (file) elements.uploadAudioBtn.textContent = file.name;
            checkFilesSelected();
        });

        elements.timestampFileInput.addEventListener('change', () => {
            const file = elements.timestampFileInput.files[0];
            if (file) elements.uploadSyncBtn.textContent = file.name;
            checkFilesSelected();
        });

        elements.loadFilesBtn.addEventListener('click', async () => {
            const audioFile = elements.audioFileInput.files[0];
            const timestampFile = elements.timestampFileInput.files[0];
            if (!audioFile || !timestampFile) return;

            resetStateAndUI();
            elements.status.textContent = `טוען קבצים...`;
            elements.container.style.display = 'block';

            try {
                const readFileAsArrayBuffer = (file) => new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsArrayBuffer(file);
                });

                const readFileAsText = (file) => new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsText(file);
                });

                const [arrayBuffer, timestampText] = await Promise.all([
                    readFileAsArrayBuffer(audioFile),
                    readFileAsText(timestampFile)
                ]);

                if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                state.timestamps = parseTimestamps(timestampText);

                elements.playChunkBtn.disabled = false;
                elements.restartBtn.disabled = false;
                if (isSpeechRecognitionSupported) elements.playMicBtn.disabled = false;
                elements.status.textContent = 'מוכן. לחץ על כפתור כדי להתחיל.';
            } catch (error) {
                console.error('Error loading local files:', error);
                elements.status.textContent = `שגיאה בטעינת הקבצים: ${error.message}`;
            }
        });

        function resetStateAndUI() {
            if (isMicrophoneMode) pauseMicrophoneMode();
            if (currentChunkSource) currentChunkSource.stop();
            audioBuffer = null;
            state.timestamps = [];
            state.chunkIndex = 0;
            elements.textDisplay.innerHTML = '';
        }

        function parseTime(timeStr) { let s=0; const m=timeStr.match(/(\d+)m/); if(m)s+=parseInt(m[1])*60; const sec=timeStr.match(/(\d+)s/); if(sec)s+=parseInt(sec[1]); const ms=timeStr.match(/(\d+)ms/); if(ms)s+=parseInt(ms[1])/1000; return s; }
        function parseTimestamps(text) { return text.split('\n').map(line => { const match = line.trim().match(/\[\s*(.*?)\s*-\s*(.*?)\s*\]\s*(.*)/); return match ? { start: parseTime(match[1]), end: parseTime(match[2]), word: match[3] } : null; }).filter(Boolean); }
        
        function calculateNextChunk() {
            const totalWords = state.timestamps.length;
            const startIndex = state.chunkIndex;
            if (startIndex >= totalWords) return { startIdx: -1, endIdx: -1 };

            const minChunkSize = 3;
            const maxChunkSize = 7;
            const wordsRemaining = totalWords - startIndex;
            const SILENCE_THRESHOLD = 0.25;
